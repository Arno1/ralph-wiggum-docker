name: Validate Commits

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate conventional commits
        run: |
          # Get commits in this PR (exclude merge commits)
          COMMITS=$(git log origin/main..HEAD --pretty=format:"%s" --no-merges)

          # Valid prefixes for conventional commits
          VALID_PREFIXES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

          ERRORS=0
          while IFS= read -r commit; do
            if [ -z "$commit" ]; then
              continue
            fi

            # Skip merge commits (backup check)
            if echo "$commit" | grep -qE "^Merge (pull request|branch|commit|[a-f0-9]+)"; then
              echo "⏭ Skipping merge commit: $commit"
              continue
            fi

            # Check if commit matches conventional commit format
            if ! echo "$commit" | grep -qE "^($VALID_PREFIXES)(\(.+\))?: .+"; then
              echo "❌ Invalid commit: $commit"
              echo "   Expected format: <type>(<scope>): <description>"
              echo "   Valid types: $VALID_PREFIXES"
              ERRORS=$((ERRORS + 1))
            else
              echo "✓ Valid commit: $commit"
            fi
          done <<< "$COMMITS"

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "Found $ERRORS invalid commit(s)."
            echo ""
            echo "Conventional Commit Format:"
            echo "  <type>(<scope>): <description>"
            echo ""
            echo "Examples:"
            echo "  feat: Add user authentication"
            echo "  fix(api): Resolve null pointer exception"
            echo "  docs: Update README installation steps"
            echo "  refactor(cli): Extract validation logic"
            exit 1
          fi

          echo ""
          echo "All commits follow conventional commit format!"
